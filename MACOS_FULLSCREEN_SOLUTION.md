# macOS 全屏模式解决方案

## 问题背景

在 macOS 全屏模式下，系统默认不允许其他应用的窗口显示在全屏应用的上层。这导致剪贴板管理器在用户使用全屏应用时无法正常显示，严重影响用户体验。

## 解决方案概述

我们实现了一个智能窗口显示系统，能够：

1. **自动检测全屏状态**：使用 AppleScript 检测当前是否有应用处于全屏模式
2. **动态调整窗口级别**：根据检测结果自动设置窗口为覆盖级别或普通级别
3. **原生 API 集成**：使用 Cocoa 原生 API 确保最佳兼容性
4. **智能级别管理**：窗口隐藏时自动重置级别，避免干扰其他应用

## 技术实现

### 核心组件

#### 1. 全屏检测 (`detect_fullscreen_app`)
```applescript
-- 使用 AppleScript 检测所有可见应用进程的窗口
-- 通过 AXFullScreen 属性判断是否为全屏窗口
```

#### 2. 窗口级别管理
- **覆盖级别 (OVERLAY_WINDOW_LEVEL = 25)**：允许在全屏应用上层显示
- **普通级别 (NSNormalWindowLevel = 0)**：标准窗口级别

#### 3. 窗口集合行为设置
```rust
// 允许在所有桌面空间中显示
let ns_window_collection_behavior_can_join_all_spaces: i32 = 1 << 0;
// 允许作为全屏应用的辅助窗口
let ns_window_collection_behavior_full_screen_auxiliary: i32 = 1 << 8;
```

### 关键函数

#### `show_window_smart(app: &AppHandle)`
智能窗口显示的核心函数：

1. **检测全屏状态**
   - 如果检测到全屏应用 → 设置为覆盖级别并显示
   - 如果无全屏应用 → 使用普通级别显示
   - 如果检测失败 → 降级到普通显示模式

2. **设置窗口属性**
   - 窗口级别 (setLevel)
   - 集合行为 (setCollectionBehavior)
   - 前台显示 (makeKeyAndOrderFront)

#### `hide_window_and_reset(app: &AppHandle)`
智能窗口隐藏函数：

1. **隐藏窗口**
2. **重置窗口级别**：避免影响下次显示或其他应用

## 使用方法

### 自动集成

解决方案已完全集成到应用中，无需手动配置：

1. **快捷键触发**：按快捷键时自动使用智能显示
2. **托盘交互**：点击托盘图标时自动应用
3. **程序化调用**：所有窗口显示都经过智能处理

### 日志监控

应用会记录详细的窗口操作日志：

```
🔍 检测到全屏应用，将窗口设置为覆盖模式
✅ 窗口已设置为覆盖级别，可在全屏模式下显示
✅ 窗口已在全屏模式下显示
```

## 兼容性说明

### 支持的 macOS 版本
- macOS 10.13 (High Sierra) 及以上版本
- 支持 Intel 和 Apple Silicon 芯片

### 权限要求
应用需要以下权限（已在 `entitlements.plist` 中配置）：

```xml
<!-- 允许使用 AppleScript 控制其他应用 -->
<key>com.apple.security.automation.apple-events</key>
<true/>

<!-- 禁用沙盒以允许系统级操作 -->
<key>com.apple.security.app-sandbox</key>
<false/>
```

### 依赖库
- `cocoa`: Cocoa 框架绑定
- `objc`: Objective-C 运行时绑定

## 故障排除

### 常见问题

#### 1. 权限被拒绝
**现象**：AppleScript 执行失败
**解决**：
1. 打开 "系统偏好设置" > "安全性与隐私" > "隐私"
2. 在 "自动化" 中允许应用控制 "系统事件"
3. 在 "辅助功能" 中添加应用权限

#### 2. 窗口仍然被遮挡
**现象**：全屏模式下窗口不可见
**可能原因**：
- 系统版本不支持覆盖级别
- 其他应用占用了更高的窗口级别
**解决**：查看日志中的错误信息，考虑降级到通知模式

#### 3. 检测失败
**现象**：日志显示 "无法检测全屏状态"
**解决**：
1. 确保给予了 AppleScript 执行权限
2. 检查 "系统事件" 应用是否正常运行

### 调试模式

开启详细日志以调试问题：

```bash
# 运行应用时启用详细日志
RUST_LOG=debug npm run tauri dev
```

## 技术细节

### 窗口级别说明

macOS 窗口系统使用数值来定义窗口的显示层级：

| 级别 | 数值 | 说明 |
|------|------|------|
| 子菜单级别 | -3 | 菜单栏下方 |
| 普通级别 | 0 | 标准应用窗口 |
| 浮动级别 | 3 | 始终在普通窗口之上 |
| 撕下菜单级别 | 5 | 撕下的菜单 |
| 主菜单级别 | 8 | 菜单栏级别 |
| 状态级别 | 10 | 状态栏级别 |
| 模态面板级别 | 19 | 模态对话框 |
| 弹出菜单级别 | 20 | 弹出菜单 |
| **覆盖级别** | **25** | **全屏应用上层** |
| 屏保级别 | 1000 | 屏幕保护程序 |

### 性能考虑

1. **检测频率**：只在窗口显示时检测，不会持续检测
2. **缓存策略**：检测结果不缓存，确保实时性
3. **降级机制**：检测或设置失败时自动降级，保证基本功能

## 未来优化

1. **智能缓存**：缓存检测结果一段时间，减少 AppleScript 调用
2. **更精确检测**：支持检测特定应用的全屏状态
3. **用户配置**：允许用户选择全屏模式下的行为策略
4. **性能监控**：添加窗口操作的性能指标

---

*本解决方案确保剪贴板管理器在 macOS 全屏模式下能够正常工作，为用户提供无缝的使用体验。* 