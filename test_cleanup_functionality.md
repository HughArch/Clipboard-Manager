# 数据清理功能测试指南

## 测试目的
验证剪贴板历史数据自动清理功能是否正常工作，包括按时间清理和按数量清理。

## 测试前准备

### 1. 检查当前设置
- 打开应用程序
- 进入设置界面
- 记录当前的 `Max History Items` 和 `Max History Time` 值

### 2. 准备测试数据
- 复制多个不同的文本内容（建议10-15条）
- 确保有一些历史数据存在

## 测试步骤

### 测试1：按数量清理功能

#### 步骤：
1. **设置较小的历史条目限制**
   - 打开设置
   - 将 `Max History Items` 设置为 `5`
   - 将 `Max History Time` 设置为 `30`（保持较大值，避免时间清理干扰）
   - 保存设置

2. **观察控制台输出**
   - 查看开发者工具控制台或终端输出
   - 应该看到类似以下的调试信息：
   ```
   保存设置: AppSettings { max_history_items: 5, max_history_time: 30, ... }
   设置已保存，开始执行清理
   开始清理过期数据，设置：max_items=5, max_time=30
   数据库连接可用，开始清理操作
   数据库中的前5条记录:
     ID: 15, 时间戳: 2024-05-25T07:30:00.000Z, 收藏: 0
     ID: 14, 时间戳: 2024-05-25T07:29:00.000Z, 收藏: 0
     ...
   当前非收藏记录数量: 12, 最大允许: 5
   需要删除 7 条多余记录
   按数量清理完成，删除了 7 条记录
   清理后统计：总记录数: 5, 收藏数: 0
   ```

3. **验证结果**
   - 刷新应用程序界面
   - 确认历史记录数量不超过5条
   - 确认保留的是最新的记录

### 测试2：收藏项保护功能

#### 步骤：
1. **创建收藏项**
   - 在现有历史记录中标记2-3个为收藏
   - 确保总记录数超过设置的限制

2. **执行清理**
   - 保存设置或重启应用程序
   - 观察控制台输出

3. **验证结果**
   - 确认收藏的项目没有被删除
   - 确认只有非收藏的旧记录被删除
   - 收藏项不计入数量限制

### 测试3：按时间清理功能

#### 步骤：
1. **设置较短的时间限制**
   - 将 `Max History Time` 设置为 `1`（1天）
   - 将 `Max History Items` 设置为较大值如 `100`
   - 保存设置

2. **观察控制台输出**
   - 应该看到时间清理的相关信息：
   ```
   时间清理：删除 2024-05-24T07:30:00.000Z 之前的记录
   按时间清理完成，删除了 X 条记录
   ```

3. **验证结果**
   - 确认只有超过1天的记录被删除
   - 收藏的项目即使超过时间限制也应该保留

### 测试4：启动时自动清理

#### 步骤：
1. **设置测试参数**
   - 设置较小的限制值
   - 确保当前数据超过限制

2. **重启应用程序**
   - 完全关闭应用程序
   - 重新启动

3. **观察启动日志**
   - 应该在启动时看到清理相关的日志输出

### 测试5：手动清理命令

#### 步骤：
1. **在浏览器控制台执行**
   ```javascript
   // 在应用程序的开发者工具中执行
   await window.__TAURI__.core.invoke('cleanup_history')
   ```

2. **观察输出**
   - 应该看到清理操作的完整日志

## 预期结果

### 正常工作的标志：
1. ✅ **调试信息完整**：能看到详细的清理过程日志
2. ✅ **按数量清理**：超出限制的记录被正确删除
3. ✅ **按时间清理**：过期记录被正确删除
4. ✅ **收藏项保护**：收藏的项目永远不被删除
5. ✅ **数量统计正确**：清理后的统计信息准确
6. ✅ **界面更新**：前端界面正确反映清理后的状态

### 故障排除

#### 如果没有看到调试输出：
1. 检查是否在开发模式下运行
2. 确认控制台/终端窗口是否正确显示
3. 尝试手动调用清理命令

#### 如果清理没有生效：
1. 检查数据库连接状态
2. 确认时间戳格式是否匹配
3. 验证设置是否正确保存

#### 如果收藏项被误删：
1. 检查 `is_favorite` 字段的值
2. 确认 SQL 查询条件正确

## 测试数据示例

### 创建测试数据的方法：
1. 复制以下文本内容（每个单独复制）：
   ```
   测试文本1 - 普通内容
   测试文本2 - 普通内容
   测试文本3 - 收藏内容（手动标记为收藏）
   测试文本4 - 普通内容
   测试文本5 - 收藏内容（手动标记为收藏）
   测试文本6 - 普通内容
   测试文本7 - 普通内容
   测试文本8 - 普通内容
   ```

2. 将其中2-3个标记为收藏

3. 设置 `Max History Items` 为 `5`

4. 保存设置并观察结果

## 成功标准

清理功能正常工作应该满足：
- 非收藏记录数量不超过设置限制
- 收藏项目完全保留
- 过期记录被正确删除
- 清理操作有完整的日志记录
- 前端界面正确更新 