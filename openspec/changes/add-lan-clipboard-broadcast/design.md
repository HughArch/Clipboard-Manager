## Context

当前应用是基于 Tauri 2.x（Rust 后端）+ Vue 3 的跨平台剪贴板管理器，剪贴板历史记录存储在本地 SQLite。现有功能主要围绕单机剪贴板与本地历史记录，缺少局域网内多设备协作能力。本变更引入“队列”概念与密码校验，提供局域网内的文本/图片复制广播与历史记录同步。

## Goals / Non-Goals

**Goals:**
- 支持客户端创建队列并设置密码，其他客户端加入队列并完成密码校验。
- 队列内成员复制文本/图片后，自动广播到队列内其他成员。
- 广播内容写入每台客户端的复制历史记录，并可识别来源。
- 提供基础的队列状态/成员显示与错误提示。

**Non-Goals:**
- 互联网/跨网段中继或云端同步。
- 端到端加密或零信任安全模型（仅局域网信任场景）。
- 文件/任意二进制数据传输（限定文本与图片）。
- 完整的多人协作冲突解决（仅追加历史记录）。

## Decisions

1. **队列拓扑：单主机队列**
   - 客户端A创建队列后在本地启动监听服务，其他成员连接到该主机。
   - 选择理由：实现简单、广播逻辑集中、故障定位清晰。
   - 替代方案：全网状 P2P 广播（复杂度高、连接管理与去重更难）。

2. **连接与发现策略**
   - 初版以“手动输入主机 IP:端口 + 密码”加入为主，可选增加 UDP 局域网广播发现（后续迭代）。
   - 选择理由：避免平台差异与防火墙问题导致发现不稳定。

3. **通信协议与消息格式**
   - 使用 TCP 连接与长度前缀帧进行传输，消息为 JSON 包装体，包含 `id`、`kind`（text/image）、`timestamp`、`origin`、`payload`。
   - 图片通过 Base64 编码放入 `payload`（受现有 5MB 图片限制）。
   - 选择理由：实现快速、与现有 Rust/Tauri 生态契合。
   - 替代方案：WebSocket 或自定义二进制协议（实现成本更高）。

4. **密码校验方式**
   - 主机保存密码哈希（如 SHA-256），客户端发送密码进行校验。
   - 选择理由：易实现、满足局域网信任场景。
   - 代价：明文密码在 LAN 内传输，存在被嗅探风险。

5. **广播去重与回环抑制**
   - 每条广播携带全局唯一 `id` 与 `origin`，客户端维护短期去重集合。
   - 收到广播后仅写入历史，不再次广播。

## Risks / Trade-offs

- **[Risk] 明文密码在局域网被嗅探** → **Mitigation**: 明确“局域网信任”前提，后续可升级为 TLS 或挑战应答。
- **[Risk] Base64 图片带来体积膨胀** → **Mitigation**: 沿用现有图片大小限制，必要时优化为二进制帧。
- **[Risk] 主机断开导致队列不可用** → **Mitigation**: 明确主机角色与断开提示，后续可支持重新选主。
- **[Risk] 防火墙阻止端口** → **Mitigation**: 允许自定义端口并提供连接失败提示。

## Migration Plan

- 作为新功能默认关闭，用户手动创建/加入队列才启用网络监听。
- 若需要在历史记录中标记来源，优先使用现有可扩展字段；如需新增数据库字段，提供迁移脚本并设置默认值。

## Open Questions

- 是否需要 UDP 广播自动发现，还是仅支持手动 IP 加入？
- 成员列表如何同步与刷新频率？
- 是否需要展示发送者名称/设备信息？
- 图片大小/频率的限制策略需要进一步明确吗？
